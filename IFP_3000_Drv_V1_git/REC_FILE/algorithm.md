 
密级：机密
文件编号：KF-BA80-3-005

	迈瑞公司	版    本：1.0

	开发文档	页    码：共 63 页

项目名称：
BS-800 全自动生化分析仪

文件名称：
算法详细设计

适用范围：
BS-800/BS-820(BA80)

拟制：	设计审核：	测试审核：	批准：
日期：	日期：	日期：	日期：
相关文档
文件编号	文件名称	版本
		
		
		
		
		
		
		
		
		
		
		
磁盘文件名称	字节数	复核	日期
KF-BA80-3-005(1.0).doc
		




修订记录
版本	修订内容概述	修订人	修订日期
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
目录
目录	3
第1章 基本概念	6
1.1	基本原理	6
1.1.1	吸光度的概念	6
1.2	反应度的概念	6
1.2.1	分光光度法（吸收光谱法）	6
1.2.2	透射比浊法	7
1.3	双波长测量	7
1.4	测试流程和测光点	8
1.5	样本空白	11
1.6	底物耗尽	11
1.7	前带检查	12
1.7.1	抗原再添加法	12
1.7.2	反应速度比法	13
1.8	血清指数	15
1.8.1	血清指数的意义	15
1.8.2	血清指数算法	15
1.8.3	血清指数因子	16
1.9	数据处理流程	17
第2章 吸光度的计算	18
第3章 分析方法及反应度的计算	19
3.1	终点法	19
3.2	固定时间法	21
3.3	动力学法	22
3.3.1	动力学法数据计算流程	22
3.3.2	确定线性范围	23
3.3.3	反应度的计算	24
3.3.4	线性度判断	25
3.3.5	酶线性范围扩展	26
3.4	反应曲线信息提取	27
3.4.1	线性回归计算	27
3.4.2	残差 的计算	27
3.4.3	吸光度变化率Rate 的计算	27
3.4.4	Initial反应启始时间段	27
3.4.5	反应曲线信息	28
第4章 定标	29
4.1	定标意义	29
4.2	定标设置中的参数解释	29
4.3	非线性定标不强制过零点	30
4.4	定标处理流程	31
4.4.1	混合空白吸光度检查	31
4.4.2	空白反应度检查	31
4.4.3	不同重复测定次数最终反应度的计算	31
4.4.4	定标重复性检查	31
4.4.5	定标灵敏度检查	32
4.4.6	定标参数的计算	32
4.4.7	定标曲线标准差	32
4.4.8	定标曲线拟合度	32
4.4.9	定标系数差别限	33
4.4.10	定标单调性判断	33
4.4.11	Recovery	33
4.4.12	Deviation	33
4.4.13	自动稀释定标的稀释因子	33
4.5	定标类型及参数计算	34
4.5.1	线性定标	34
4.5.2	非线性定标	35
4.5.3	定标曲线	37
4.6	定标曲线单调性判断	37
4.6.1	Logistic-Log4P	37
4.6.2	Logistic-Log5P	37
4.6.3	Exponential5P	38
4.6.4	Polynomial5P	39
4.6.5	Parabola	40
4.6.6	Spline	40
4.7	定标算法	41
4.7.1	最小二乘法	41
4.7.2	Spline插值函数	46
4.7.3	非线性定标类型利用L-M法求解时的f函数及J函数	48
第5章 测试结果的计算	51
5.1	非线性方程f(x)＝0的二分法求解	51
5.2	浓度计算	51
5.2.1	线性定标	52
5.2.2	非线性定标	52
5.2.3	样本增量或减量测试结果的计算	53
5.2.4	自动稀释测试结果的计算	54
5.2.5	测试结果相关性修正	54
5.2.6	手工稀释测试结果的计算	54
5.3	浓度水平检查	54
第6章 自动重测	56
第7章 各类检查与报警总结	58
7.1	吸光度/反应度检查	58
7.2	浓度检查	58
7.3	定标检查	59
附录A 相对BS400算法的更改点	61
附录B 图、表目录	62






	
第1章 基本概念
1.1	基本原理
1.1.1	吸光度的概念
一束强度为I0的平行单色光通过一个含有浓度为C的吸光物质、厚度为L的吸收池时，如图1所示，一些光子被吸收，光强从I0衰减为It，则该溶液的吸光度A等于：
 
其中It /I0为透光率。
 
图1溶液对光的吸收
1.2	反应度的概念
在BS系列生化仪中，反应度R定义为：反应前后或反应过程中吸光度的变化或变化率。
反应度R的计算公式与所采用的测定方法，试剂数(单、双试剂)、波长数(单、双波长)密切相关，详细描述见第三章。
1.2.1	分光光度法（吸收光谱法）
分光光度法是一种灵敏、快速、准确、简单和具有较好选择性的分析方法，它在分析化学、分析生化和医学检验中占有非常重要的地位。
根据朗伯－比耳（Lamber-Beer）定律：溶液的吸光度等于该溶液的吸光系数、浓度C和光径L(cm)的乘积，当光径不变时，浓度和吸光度成正比，即
 
其中 为吸光系数，有两种表示方法：摩尔吸光系数和比例吸光系数，摩尔吸光系数的意义为1摩尔浓度的溶液在厚度为1cm时的吸光度，比例吸光系数的意义为浓度为1%(w/v)的溶液在厚度为1cm时的吸光度；C为溶液的浓度；L为吸收池的厚度(单位为cm，亦称光径)。 
朗伯－比耳（Lamber-Beer）定律是生化分析仪利用吸收光谱法进行定量测定的基础。




1.2.2	 透射比浊法
一束强度为I0的平行单色光通过一个含有悬浮质点(颗粒大小与光源波长接近)的悬浮液或胶体溶液时，其透射光强度I可用下式表示：
			                  	 
式中，L为悬浮液或胶体溶液在光前进方向上的长度，τ为浊度系数，与悬浮质点的浓度C成线性关系。令τ=2.3KC，则：
  , 即   
与Lamber-Beer定律相似，这是生化分析仪利用透射比浊法进行定量测定的基础。该法可以与吸收光谱法共用一个检测器，所有生化分析仪，不需增加任何部件，均可利用此法进行测定。
注意：比浊法项目吸光度与溶液中的悬浮质点浓度C成线性关系，但反应形成的悬浮质点浓度C与待测物的浓度CX不成线性关系，这就是为什么比浊法项目需用非线性定标的原因。同理，比色法项目反应形成的溶液浓度与待测物的浓度成线性关系，因此，比色法项目需用线性定标。
1.3	双波长测量
全自动生化分析仪设计中常用双波长法。即在整个反应全过程监控中，主副波长同时监测，全过程每点主波长吸光度值都同时减去同点副波长吸光度值。如图2所示。
 
图2 双波长测量
即 ，当 时， 。
双波长是一种补偿方法，其有效的条件是干扰物的吸收对波长无选择性，指示物对波长具有选择性。通过求主波长与副波长的吸光度差，可有效扣除干扰，并可降低噪声的影响（光源的闪烁，漂移，反应杯的划痕等）。
1.4	测试流程和测光点
双试剂项目的测试流程如下：
 
图3 BS-800双试剂项目测试流程
单试剂项目的测试流程在双试剂项目的测试流程基础上去掉加R2动作，但R2搅拌还保留。
如果为四试剂项目，则在第一个大循环结束时停止自动清洗，在下一循环中实现四试剂项目的测试，其中R3在R1加入位加入，在S搅拌位搅拌，R4在R2加入位加入，在R2搅拌位搅拌。
 
图4 BS-800四试剂项目测试流程
三试剂项目的测试流程在四试剂项目的测试流程基础上去掉加R4动作，但R4搅拌还保留。










BS-800为恒速系统，周期时间4.5S，光测点间隔周期为18秒，即每4个周期采集一次光电数据。单双试剂项目的采集光电数据的具体时刻如下：
 
图5 BS-800双试剂项目光测图
其中17点为加入R2后未搅拌点，为无效点，在反应曲线上不予显示。


	
三四试剂项目的采集光电数据的具体时刻如下：
 							
图6 BS-800四试剂项目光测图
第161周期至188周期中的光测点处于加减速台阶上，因此中间7个光测周期未进行光电采集。17点为加入R2后未搅拌点也为无效点，在反应曲线上不予显示；P36，37，38，39为加入R3后未搅拌点，为无效点，在反应曲线上不予显示；P52点为加入R4后未搅拌的点，在反应曲线上不予显示。



针对BS800不同的反应类型，其测光时间点的说明如下：
	表 1  BS800无效点和启动点说明
反应类型	无效点	启动点
R1+S	无	5
R1+S+R2	17	18
R1+S+R2+R3	17，36，37，38，39	40
R1+S+R2+R3+R4	17，36，37，38，39，52	53
注：启动点为最后一个反应物加入并搅拌后的第一个测光点。


1.5	样本空白
	目的
样本空白校正是为了排除非成色反应，如样本干扰（溶血，黄疸，脂血）对吸光度的影响。
	测定方法
样本空白测定同普通样本测定，只是“试剂”改为等量的生理盐水，然后按照实际工作模式进行测定。有些项目做测试前必须要做样本空白，项目参数中提供用户选择测试该项目时是否要先做样本空白测试。如果选中样本空白，则做该项目的定标、质控和样本测试时必须先做该项目的样本空白测试。
	只对单试剂终点法有效
样本空白在反应时间内的反应曲线几乎为一直线，斜率可认为0，因此样本空白对固定时间法和动力学法没有意义。另外，双试剂、三四试剂终点法可通过参数设定扣除样本空白，因此，样本空白只对单试剂终点法有效。
1.6	底物耗尽
只对固定时间法和动力学法有效。
底物耗尽限的意义：一些高浓度（活性）样品使底物耗尽，使反应不再为0级(动力学法)或1级(固定时间法)反应，为能正确反映测定结果，需设置底物耗尽限(某一特定吸光度)，判断反应曲线的线性区与非线性区(动力学法)或1级反应区与多级反应区(固定时间法)的临界点。底物耗尽限是在反应时间内反应没有发生底物耗尽时，相对反应启动点所能达到的最大吸光度升高（反应曲线上升）或最大吸光度降低（反应曲线下降）。
测光点是否发生底物耗尽的判断方式：
|A测光点-A启动点|<底物耗尽限，则未发生底物耗尽。
底物耗尽限要求输入大于0的数。

1.7	前带检查
 
图7 抗原抗体反应的剂量反应曲线
在抗原抗体的反应中，生成的不溶性抗原抗体复合物与抗原抗体的比例密切相关，在适当比例时生成的不溶性抗原抗体复合物量最大，此时透过的光最少，相当于吸光度最大；大于和小于这个比例时，生成的不溶性抗原抗体复合物量都会减少，透过的光增加，吸光度减小。在这种情况下，浓度相差很大的两份样本（抗原），生成的不溶性抗原抗体复合物量可以相等，如果不进行前带检查，会得到相同的测定结果。如图7所示。因此，对于抗原抗体反应，有必要进行前带检查。
前带限指没有出现抗原过剩时允许的最大或最小PC值。
前带检查参数：
前带限【PCM】  【q1】【q2】【q3】【q4】
前带检查吸光度下限值【abs.lowlimit】
1.7.1	抗原再添加法
判断抗原过剩最直接的方法为抗原再添加法。在抗体过量前提下，待测抗原在反应介质中与抗体快速反应形成稳定的小复合物颗粒，产生散射光信号，该信号随复合物的增加和时间的延长（抗体过量阶段）而动态性增强，在规定时间内如果抗体保持过量，再次加入抗原后会继续反应，反应幅度会继续上升，如果抗原已过量，则反应下降。如图8所示。
 
图8 抗原再添加的反应曲线
抗原再添加项目通过再往反应杯中添加样本来判断是否抗原过剩，由于样本针能到的位置是固定的，所以只能是本次大循环结束时不清洗反应杯，在下一大循环的加样周期内再向该反应杯中加入样本。具体测试流程如下：
 
图9 抗原再添加的测试流程
   对单试剂抗原再添加项目不需要加R2，但需要进行R2和R4搅拌，参数判断是在R3搅拌完后进行。
前带检查参数输入：
前带限【PCM】  【q1】【q2】【0】【0】
前带检查吸光度下限值【abs.lowlimit】灰色，即当q3＝q4＝0时，该项不可输入。
68≥q2≥40>q1≥反应时间终点。40为再次加入样本并搅拌后的第一个测光点。
样本PC值：PC＝Aq2-k×Aq1 
k为体积校正因子，单试剂项目：k＝(VR1+VS)/(VR1+2VS)，
双试剂项目：k＝（VR1+VS+VR2）/( VR1+2VS+VR2)
对于上升反应，若PC<PCM；下降反应，若PC>PCM，给出前带检查异常“PRO”标记，并报警。
1.7.2	反应速度比法
反应速度比法是根据在一定的相同的时间内，抗体过剩反应曲线能够达到平衡，如图10所示；而抗原过剩反应曲线达不到平衡，如图11所示。具体判断方法：
前带限【PCM】  【q1】【q2】【q3】【q4】
前带检查吸光度下限值【abs.lowlimit】
样本PC值：    若PC> PCM，给出前带检查异常“PRO”标记，并报警。
测光点输入要求：
单试剂项目：5≤q1 <q2< q3< q4≤33， 5为加入样本搅拌后第一个测光点。 
双试剂项目：18≤q1 <q2< q3< q4≤33，18为加入R2搅拌后第一个测光点。
以下两种情况，不再进行前带检查。
（1）	|样本终点吸光度-反应启动点吸光度|< abs.lowlimit
（2）	样本反应度绝对值R>RCMAX(最大浓度标准品反应度绝对值)。
 
图10 抗体过剩的时间反应曲线
 
图11 抗原过剩的时间反应曲线

1.8	血清指数
1.8.1	血清指数的意义
溶血[Hemoglobin]，脂血[Lipemia]，黄疸[Icterus]是血清中常见的三种干扰物。
血清指数是指血清样本中溶血、黄疸和脂血的程度。
已知样本中三种干扰物的存在，将通过物理干扰或化学干扰的形式，影响生化分析结果的准确性，从而影响临床医生的诊断。
以物理干扰为例，细微气泡或固体颗粒对波长无选择性，对吸收光谱平行抬高，因此可用双波长检测法消除其干扰。但对于黄疸、溶血、脂血干扰物，其对波长具有选择性，吸收光谱复杂（如下图所示），单靠双波长检测不能完全消除其干扰，从而导致假性结果。
 
图 12  血清干扰物吸收光谱
原始的血清干扰物目测方法，只能对样本受干扰水平进行粗略的估计，且过度依赖操作者的经验和自觉性，较不可靠。
生化仪提供血清指数测量功能，自动分析给出样本的血清干扰物信息，将有利于辅助临床医生评估测试结果是否有效，决定标本是否可用，或决定是否需进行样本空白校正。血清指数的测量，提高了检验的可靠性。
1.8.2	血清指数算法
血清指数测试方法：
单试剂终点法项目。样本为待测血清，样本量固定10ul。试剂固定为生理盐水，试剂量固定为200ul。固定取P7至P10点的吸光度均值参与计算。
具体算法：
选择450，505，570，605，660，700nm，6个波长来确定血清指数。
	脂血指数的测定：主波长660，次波长700。
 ，脂血指数： 
	溶血指数的测定：主波长570，次波长605。
 ，溶血指数： 
	黄疸指数的测定：主波长450，次波长505。
 ，黄疸指数： 
    
结果定性判断：
对计算得到的血清指数结果LHI，允许分别进行定性判断，并给出相应的定性标记。
对每种干扰物结果，定性标记需要6个输入框，定性判断阈值需要5个输入框。
定性判断阈值接受正小数依次递增的输入。以L为例，定性判断输入L1至L5，要求0<L1<L2<L3<L4<L5。当结果L满足L<L1，对应定性标记1，以此类推，当结果L满足L>L5，对应定性标记6。6个定性标记不可重复。
1.8.3	血清指数因子
血清指数因子A、B、C、D、E、F参考值的确定：
分别配置浓度CL的脂血样本，浓度CH的溶血样本，浓度CI的黄疸样本，利用BS系列生化仪提供的6个血清指数波长确定计算因子。
根据脂血样本与生理盐水按比例混合后的吸光度，计算C、B、F：
      ，   ，  
根据溶血样本与生理盐水按比例混合后的吸光度，计算A、E ：
      ，  
根据黄疸样本与生理盐水按比例混合后的吸光度，计算D：
 
6个血清指数参数里，参数B、F决定于脂血干扰样本的光谱特性，参数E决定于溶血干扰样本的光谱特性。B、E、F不可调节。
其余3个参数，C由单一脂血干扰样本决定，A由单一溶血干扰样本决定，D由单一黄疸干扰样本决定。用户可通过调节A、C、D来调节血清指数结果，允许输入大于0的小数。
下表给出了BS系列的血清指数算法的默认参数。
表2 血清指数算法参数
C	B	F	A	E	D
1.45	1.42	4.55	2.20	1.31	250


1.9	数据处理流程
 
图13  数据处理流程图


第2章 吸光度的计算
通过光电转换、线性放大、AD转换等环节测量光的强度。对于第i通道的信号光强Ii，其AD输出Di为： 
 
其中，Kpe：光电转换因子；Ka ：线性放大倍数；Kad：AD转换因子；Di ：第i通道的测量数据；Li：第i通道的光强。
则有：
 
其中：Ai即为第i通道的吸光度值，Di0为水空白的AD输出，Di为加入待测物后的AD输出。
理论上，在没有开灯的情况下，各通道的AD输出应该为0，但实际上由于暗电流的存在，此时仍有一本底输出Did，应予以扣除，因此完整的吸光度公式应为：
  
该公式是以水空白为本底，而不是以杯空白为本底。
注意：使用5mm光径的反应杯，应转化为1cm光径，即吸光度*10/5，单位为A；其次由于吸光度数值较小，为方便用户查看，应乘以一放大因子，一般取10000。即最终显示给用户看的吸光度为： 
 （单位为A/10000）







第3章 分析方法及反应度的计算
	分析方法：终点法、固定时间法、动力学法
	项目参数设置：
空白时间【N】【P】  反应时间【L】【M】
	若为双波长测试，下述的吸光度A为主副波长的吸光度之差；否则，A为主波长吸光度。
	符号校正：对于下降反应的测试项目，取其反应度的相反数即R=R*(-1)做为最终参与测试结果计算的反应度。
	加样本量说明
BS800的加样模块可支持1.5-35ul范围内0.0625ul的样本递进量。
软件内部，针对输入样本量不能被0.0625整除的情况，四舍五入后，得到能够被0.0625整除的实际样本量Vs。
比如，如果输入样本量为1.6ul，则软件内部将1.6ul转化为1.625ul（1.6/0.0625=25.6微步，四舍五入取26个微步，即26*0.0625=1.625ul）的实际加样量。
后续的结果计算，如果用到加样本体积（譬如计算体积校正系数K，或增减量因子），均须使用实际加样量参与计算。
3.1	终点法
指经过一段时间的反应，反应达到平衡，由于反应的平衡常数很大，可认为全部底物(被测物)转变成产物，反应液的吸光度不再增加(或降低)，吸光度的增加(或降低)程度与被测物的浓度成正比。这类方法通常称为“终点”法，更确切地说应称“平衡”法，这是最理想的分析类型。
	反应时间内的代表吸光度Ai的计算：
若L=M，即输入[M] [M]，只利用一点，则用于计算的反应时间内的代表吸光度为该点吸光度，即Ai＝AM。
若L=M-1，即输入[M -1] [M]，利用两点，则用于计算的反应时间内代表的吸光度为该两点吸光度的均值，即Ai＝ 。
若L=M-2，即输入[M-2] [M]，利用3点，则用于计算的反应时间内的代表吸光度为除掉最大值和最小值后的吸光度值。
若M>L+2，则用于计算的反应时间内的代表吸光度为除掉最大值和最小值后的剩余吸光度的均值。
	空白时间内的代表吸光度Ab的计算：
计算方法同反应时间内的代表吸光度Ai计算。
当N=P=0时，不计算Ab的值。
	体积校正因子K1，K2，K3，K4的计算：
 
 
 
 
	其中，VR1，VR2，VR3，VR4为第一、二、三、四试剂的体积，Vs为实际加样本体积。
	反应度的计算：  
	K为体积校正因子，随项目参数不同，K取不同值。
表 3  终点法反应度计算总结
终点法	空白时间	反应时间	K
空白时间在反应启动前
单试剂	1≤N≤P≤4	5≤L≤M≤33	K1
双试剂	5≤N≤P≤16	18≤L≤M≤33	K2
三试剂	18≤N≤P≤35	40≤L≤M≤68	K3
四试剂	40≤N≤P≤51	53≤L≤M≤68	K4
空白时间在反应启动后
单试剂	5≤N≤P	P<L≤M≤33	1
双试剂	18≤N≤P	P<L≤M≤33	1
三试剂	40≤N≤P	P<L≤M≤68	1
四试剂	53≤N≤P	P<L≤M≤68	1
不扣除空白
单试剂	N=P=0	5≤L≤M≤33	0
双试剂	N=P=0	18≤L≤M≤33	0
三试剂	N=P=0	40≤L≤M≤68	0
四试剂	N=P=0	53≤L≤M≤68	0

	单试剂终点法项目样本空白校正后的反应度：
对于单试剂终点法项目，如果项目设置了样本空白，样本空白反应度也以上述R公式计算，即 ，则经过样本空白校正后的反应度为 。 




3.2	固定时间法
固定时间法又称一级动力学法，指在一定的反应时间内，反应速度与底物浓度的一次方成正比，即v=k[S]。由于底物在不断的消耗，因此整个反应速度在不断的减小，表现为吸光度的增加(或降低) 速度越来越小。这类反应达到平衡的时间很长，理论上可以在任意时间段进行监测，但由于血清成份复杂，反应刚启动时反应较复杂，杂反应较多，必需经过一段延迟时间才能进入稳定反应期。对于任何一级反应，反应开始后在一给定时间t时底物浓度[S]为： 。
其中[S0]是最初的底物浓度，e是自然对数的底，k是速度常数。在t1到t2的固定时间间隔中，底物浓度的变化量Δ[S]与[S0]的相互关系为： 。
即在一固定时间间隔TL~TM中，底物浓度的变化量正比于底物的初浓度。这是一级反应的通性。该段时间内吸光度的增加(或降低)与被测定物的浓度成正比。固定时间法又被称为初速率法、一级动力学法、二点动力学法等。
根据测光点的输入形式，固定时间法可分为单区间固定时间法和双区间固定时间法。双区间固定时间法可实时扣除样本空白，即利用孵育时间内两点间的吸光度变化作为样本空白扣除。
	反应度的计算：
  
表 4  固定时间法反应度计算总结
固定时间法	空白时间	反应时间	K
空白时间在反应启动前
单试剂	1≤N<P≤4	5≤L<M≤33	K1
双试剂	5≤N<P≤16	18≤L<M≤33	K2
三试剂	18≤N<P≤35	40≤L<M≤68	K3
四试剂	40≤N<P≤51	53≤L<M≤68	K4
不扣除空白
单试剂	N=P=0	5≤L<M≤33	0
双试剂	N=P=0	18≤L<M≤33	0
三试剂	N=P=0	40≤L<M≤68	0
四试剂	N=P=0	53≤L<M≤68	0

	底物耗尽判断：
固定时间法可进行底物耗尽检查（查看两点是否发生了底物耗尽），若发生底物耗尽，在结果上给出相应标记。




3.3	动力学法
又称零级动力学法，指反应速度与底物浓度的零次方成正比，也就是与底物浓度无关。因此，在整个反应过程中，反应物可以匀速地生成某个产物，导致被测定溶液在某一波长下吸光度均匀地减小或增加，减小或增加的速度(△A/min)与被测物（催化物）的活性或浓度成正比。动力学法也被称为连续监测法；主要用于酶活性的测定。
实际上，由于底物浓度不可能足够大，随着反应的进行，底物消耗到一定程度后，反应不再为零级，因此，零级动力学法是针对于特定时间段而言的；同样，由于血清成份复杂，反应刚启动时反应较复杂，杂反应较多，必需经过一段延迟时间才能进入稳定反应期，各试剂商对这两段时间有严格规定。 
动力学法是根据指定的测光点之间的吸光度变化得到浓度或活性值。
3.3.1	动力学法数据计算流程
 
图14  动力学法数据处理流程











3.3.2	确定线性范围
线性范围的确定：根据底物耗尽限来确定。
线性范围只在反应时间内查找确定，空白时间内不必进行线性范围的查找。
 
图15 动力学法线性范围判断流程
   

图16 动力学法线性范围


统计底物耗尽限水平内的测光点个数N。若N≥3，线性范围为反应时间起点至底物耗尽限内的所有测光点。否则，给出无线性区间“NLN”报警。对于N=0或1启动酶线性扩展，对于N=2给出报警，但要利用2个测光点进行反应度的计算。

3.3.3	反应度的计算
	反应时间段的吸光度变化率⊿ALM’：
在线性范围L至M’内利用最小二乘法计算反应度⊿ALM’：
 
其中，L为线性范围起点，M’为线性范围终点，Ai为i点的吸光度， 为L到M’点的平均吸光度，Ti为i点的实际测光时间(单位为秒)， 为为L到M点的平均时间。
    如果反应时间段未发生底物耗尽的测光点少于2，则按照酶线性范围扩展方式计算吸光度变化率。
	空白时间段的吸光度变化率⊿ANP：
   与反应时间段的吸光度变化率⊿ALM’的计算公式项目。
如果N=P=0，则空白时间段的吸光度变化率为0。
	反应度的计算：
 
表 5  动力学法反应度计算总结
动力学法	空白时间	反应时间	K
空白时间在反应启动前
单试剂	1≤N<P≤4	5≤L<M≤33	K1
双试剂	5≤N<P≤16	18≤L<M≤33	K2
三试剂	18≤N<P≤35	40≤L<M≤68	K3
四试剂	40≤N<P≤51	53≤L<M≤68	K4
不扣除空白
单试剂	N=P=0	5≤L<M≤33	0
双试剂	N=P=0	18≤L<M≤33	0
三试剂	N=P=0	40≤L<M≤68	0
四试剂	N=P=0	53≤L<M≤68	0
注：BS800动力学法要求M-L≥2，即项目参数中反应时间段最少包括3个点。
	

3.3.4	线性度判断
线性度= 
其中， ， ， 分别为反应曲线前部分、后部分及所所有点的吸光度变化率，其计算依据线性范围内的测光点数N而定，如下：
1.	当N>8时， 为前6个点的吸光度变化率， 为后6个点的吸光度变化率， 为所有点的吸光度变化率； 
2.	当 时， 为前3个点的吸光度变化率， 后3个点的吸光度变化率， 为所有点的吸光度变化率；
3.	当N 3时，不做线性度检查。
4.	  0.006A/分或  0.006A/分时，不做线性度检查。  
          N>8                                   4 N 8
        
图17  线性度计算
计算出的线性度与项目参数中的线性限（默认值为0.2）比较，如果大于线性限，给出非线性“LIN”标记，并报警。项目参数中线性限的输入为0～1的小数。


3.3.5	酶线性范围扩展
 
图18 酶线性范围扩展
在进行高活性的酶检验时，底物很快耗尽，反应曲线呈现明显非线性（一平坦曲线），如果利用通常的程序进行测量，会出现无线性区间报警，提示用户进行稀释重测，增加了工作量。
酶线性范围扩展办法：
设反应启始的时间为t1，反应时间段为tL～tM，则t1～tL为延迟时间。
当反应时间段内查找的线性范围的测光点个数N<2，不足以计算反应度时，可启动酶线性范围扩展功能，利用包括延迟时间在内的测光点数据计算最大反应速率（⊿Amax）作为该样本的反应度。
⊿Amax的计算方法如下：
在t1～tL延迟时间段内，查找未发生底物耗尽的线性范围t1～tL’。
若延迟时间内没有发生底物耗尽的点少于2个，不再计算结果，给出无计算区间“ENC”标记，并报警。
否则，在t1～tL’内，计算反应速率⊿A＝60*(Ai＋1-Ai)/（ti＋1－ti），i＝1，2…L’。则最大的⊿A即⊿Amax做为样本的反应度，从而实现了酶线性范围的扩展。对于利用酶线性扩展计算出的测试结果，给出“EXP”标记。











3.4	反应曲线信息提取
为更好的保证测试结果的可靠性，需要结合具体的临床试剂，针对反应曲线进行更全面的检查。在封闭系统的报警限建立前，只提取反应曲线信息，不对这些信息进行判断。提取下列反应曲线信息，与反应度和浓度结果一起，保存在数据库中，目前不在界面显示。
3.4.1	线性回归计算
对n个吸光度数据（t1，A1），(t2，A2)……(tn，An) 进行线性回归计算，线性回归公式为A=slope *t+intercept
其中A为吸光度，t为时间（以秒为单位），Slope，intercept分别为线性回归的斜率和截距。
参数slope ，intercept利用最小二乘法计算，
 
  
3.4.2	残差 的计算
计算公式： 
其中 为实际测试得到的吸光度， 为利用线性回归公式拟和得到的吸光度。
3.4.3	吸光度变化率Rate 的计算
指每分钟的吸光度变化率，计算公式为：rate=slope×60。
3.4.4	Initial反应启始时间段
启始时间段界面不可设置，数据库中提供启始时间段的起点【S】和终点【E】值。对于用户设置的项目，默认启始时间段起点【S】为反应启动点，启始时间段终点【E】为反应启动点之后的一个测光点。
	表 6  BS800默认启始时间段
反应类型	起点【S】	终点【E】
R1+S	5	6
R1+S+R2	18	19
R1+S+R2+R3	40	41
R1+S+R2+R3+R4	53	54


3.4.5	反应曲线信息
下表给出了需要提取的反应曲线信息。
表7 反应曲线特征量
Water Blank	主波长水空白AD值
R1 ABS	加入样本前一周期（P4测光点）的吸光度
Final ABS	反应时间段终点【M】的吸光度值
Initial ABS	启始时间段起点【S】的吸光度值
Initial Rate	启始时间段【S】【E】内每分钟的吸光度变化率
Blank ABS	空白时间段【N】【P】内各周期吸光度值的平均值
Blank Rate	空白时间段【N】【P】内每分钟的吸光度变化率
Blank MeanDevia	空白时间段【N】【P】内各点实测吸光度与对应各点线性拟和的吸光度之差绝对值即各点残差绝对值 的的平均值

Blank MaxDevia	空白时间段【N】【P】内各点实测吸光度与对应各点线性拟和的吸光度之差绝对值即各点残差绝对值 的最大值

Reac ABS	反应时间段【L】【M】内各周期吸光度值的平均值
Reac Rate	反应时间段【L】【M】内每分钟的吸光度变化率
Reac MeanDevia	反应时间段【L】【M】内各点实测吸光度与对应各点线性拟和的吸光度之差绝对值即各点残差绝对值 的的平均值

Reac MaxDevia	反应时间段【L】【M】内各点实测吸光度与对应各点线性拟和的吸光度之差绝对值即各点残差绝对值 的最大值

注：对N=P=0的情况，不计算Blank时间段信息。
注：对动力学法项目，改为针对线性范围【L】【M’】计算Reac时间段信息。线性范围内测光点数少于2的情况，不计算相关信息。
注：对终点法项目，若某时间段的起点和终点相同，不计算Rate。


第4章 定标
4.1	定标意义
测定标准品(浓度已知)的反应度，根据浓度和反应度间的数学关系（定标类型），计算出关系式中的系数（即定标参数），从而确定浓度和反应度间的具体数学表达式。普通样本根据该系数已知的表达式及测得的反应度求出样本浓度。
如：对于线性定标C＝k×(R-b)，根据已知的标准品浓度（C1，C2）和利用生化仪测得的标准品反应度(R1，R2)，可计算出k＝（R1-R2）/(C1-C2)，b＝R1-C1/k。对于反应度为RX的样本，则其浓度为CX=k×(RX-b)。

4.2	定标设置中的参数解释
表8 定标设置中的参数解释
字段	解释
定标规则	单点线性（K因数法）、两点线性、多点线性、Logistic-4P、Logistic-5P、exponential-5P、polynomial5p、spline 和parabola中选择一个。
重复测定次数	每个标准品重复测定的次数，范围1-5。默认值为1，最后结果计算见后面描述。
混合空白吸光度范围	取空白液反应终点吸光度作为混合试剂空白吸光度检查值。输入范围-32000～32000，默认值-32000～32000。不输入时，表示不进行此项检查
空白反应度检查	取空白液反应度作为空白反应度检查值。输入范围-32000～32000，默认值-32000～32000。不输入时，表示不进行此项检查
重复测定差别限	每个标准品多次测定反应度R的最大与最小值之差，大于此限给出“DUP” 标记并报警。范围0~32000，默认值为32000，不输入时，表示不进行此项检查。
定标灵敏度	指最大浓度标准品和最小浓度标准品反应度R的差值，小于此值给出“SEN” 标记并报警。范围0~32000，默认值为32000，不输入时，表示不进行此项检查。
定标系数差别限	仅对线性定标有效，指定标参数k(曲线斜率)本次与上次的差别((本次-上次)/上次)，默认值为20%，大于此限给出“FAC” 标记并报警。不输入时，表示不进行此项检查。
定标曲线标准差	对多点线性和非线性定标有效。超出此限，给出“CSD” 标记并报警，并给出此次定标的拟和度，计算公式见后。默认值为32000，不输入时，表示不进行此项检查。计算公式见后。
定标曲线拟合度	对多点线性和非线性定标有效。低于此限，给出“DET” 标记并报警。范围0~1，默认值为0，不输入时，表示不进行此项检查。计算公式见后。




4.3	非线性定标不强制过零点
对非线性定标方式，不强制要求用户提供0浓度定标液。
设用户输入的定标液浓度为C[1]，C[2], C[3]…，C[n]；
相应各定标液的反应度为Rij（第 个标准品第j次的反应度）。
	内部转换浓度的概念：
直接利用不过0点的定标浓度点进行非线性拟合，容易出现定标不收敛的情况。为了不影响算法非线性定标参数的计算，对用户输入的定标浓度C[i]，施加一个负偏移量C[1]，得到过0点的内部转换定标浓度Ci。
定义：内部转换浓度C’=实际浓度C-用户输入最低定标浓度值C[1]
对各个定标浓度点：
内部转换定标浓度Ci=C[i]-C[1]；当i=1时，C1=0；
	定标参数的计算：
利用过0点的内部转换定标浓度Ci和定标反应度Rij，计算非线性定标的参数。计算方法参见4.5.2节。
由拟合得到的非线性定标参数和用户输入最低定标浓度值C[1]，方可唯一的确定一次定标。
	给定浓度点的拟合反应度：
对给定浓度点，先计算其内部转换浓度。已知内部转换浓度，根据定标类型和定标参数，即可计算出拟合反应度 。计算方法参见4.5节。
	定标曲线绘制：
定标曲线，对定标液最小浓度和最大浓度之间的各细分浓度点，绘制浓度—拟合反应度曲线。
	结果的计算：
已知样本反应度，由定标类型和定标参数，先计算出对应的内部转换浓度。再加上C[1]，即得到结果浓度。
转换公式：实际浓度C=内部转换浓度C’+用户输入最低定标浓度值C[1]	
计算方法参见第5章。

4.4	定标处理流程
 
图19  定标处理流程图
4.4.1	混合空白吸光度检查
只有用户输入的0浓度定标液的测试，才检查混合试剂空白。记录反应时间终点时刻的吸光度，并与混合试剂空白吸光度范围比较，超出此限，给出“MBK”标记并报警。
4.4.2	空白反应度检查
只有用户输入的0浓度定标液的测试，才检查空白反应度。超出限制给出“BLK” 标记并报警。
4.4.3	不同重复测定次数最终反应度的计算
	次数=2，最终结果=2次反应度的平均值 
	次数=3，最终结果=3次反应度的中值
	次数=n(n=4-5)，最终结果=去掉最大和最小值后，剩下n-2次反应度的平均值
	  下面定标重复性检查，曲线标准差(SD)和决定系数(R2)计算公式中，只采用参与了最终反应度计算的那些测定次数的数据(有效测定次)。
		注意：对n=3的情况，除去偏差最大的反应度，其余两次为有效定标测定次数。
4.4.4	定标重复性检查
定标重复性：指每个标准品有效测定次数反应度的最大与最小值之差。
该差值有一允许范围，可作为参数“重复测定差别限”输入仪器，大于此限给出“DUP” 标记并报警。报警时可使问题分析集中到样品、试剂的定量吸注、反应温度的控制及光电检测系统的稳定性等方面。范围0~32000，默认值为32000，此时表示不进行此项检查。
4.4.5	定标灵敏度检查
定标灵敏度：指最大浓度标准品和最小浓度标准品最终反应度的差值。
“定标灵敏度限”用作灵敏度检查，允许用户输入正值。计算最大浓度标准品和最小浓度标准品最终反应度的差值的绝对值，小于该限值给出“SEN” 标记并报警。
差值越大，敏感度越好，差值越小，低于敏感度检查下限，可能是因为试剂空白吸光度过高，也可能是标准品降解而致吸光度下降。如果试剂出现问题，则会在试剂空白核查中发现；如果试剂、标准品没有问题，敏感度下降可能因仪器信号转换、放大系统故障所致。范围0~32000，默认值为32000，此时表示不进行此项检查。
4.4.6	定标参数的计算
详见4.4节，在此不在赘述。
4.4.7	定标曲线标准差
计算公式：
 
当 =1，且 时，SD计算公式中的分母 ，此时：
 
其中： 为标准品的个数， 为每一标准品有效的重复测定次数， 为第 个标准品第j次的反应度， 为根据定标曲线计算出来的标准品i的反应度，  为自由度，等于定标参数个数。
注意：对于SPLINE定标， ＝4，而非4（n－1），n为标准品个数。
多点线性和非线性定标，计算出的定标曲线标准差与用户输入的“定标曲线标准差”相比较，如果大于用户输入值，给出“CSD” 标记并报警，并给出此次定标的定标曲线拟和度及定标曲线的标准差。
4.4.8	定标曲线拟合度
曲线的拟合度即曲线的决定系数R2，它反应了曲线拟合的好坏，其值介于0~1之间，计算公式如下：
 
其中： 为标准品的个数， 为有效的重复测定次数， 为第 个标准品第j次的反应度， 为根据定标曲线计算出来的标准品i的反应度， 为所有标准品最终反应度的平均值。
多点线性和非线性定标，计算出的定标曲线拟合度与用户输入的“定标曲线拟合度”比较，低于此限，给出“DET” 标记并报警。
4.4.9	定标系数差别限
定标系数差别限：仅对线性定标有效，指定标参数k(曲线斜率)本次与上次的差别((本次-上次)/上次)。
定标系数差别  ，该值超过用户输入的“定标系数差别限”，给出“FAC”标记并报警。默认值为20％。输入0表示不进行此项检查。
4.4.10	定标单调性判断
 仅对非线性定标有效。具体见4.6节。
4.4.11	Recovery
根据相应定标类型的定标参数及每个定标液的最终反应度，计算定标液的浓度（计算方法参考第5章测试结果的计算）。该浓度值即为Recovery。可以理解为，定标成功后，以定标液作为样本，测试其浓度值。Recovery和定标液浓度值越接近越好。
计算出来的recovery 保存在数据库中，不在界面中显示。
4.4.12	Deviation
只对非线性定标有效。
计算公式： 
其中 为各定标浓度点实测的反应度， 为各定标浓度点的拟合反应度。
计算出来的Deviation保存在数据库中，不在界面中显示。
4.4.13	自动稀释定标的稀释因子
BS800支持自动稀释定标，即利用“预稀释＋增量减量”的定标加样方式，扩展出不同的定标浓度点。定标设置界面需要显示自动稀释定标的稀释因子，下面介绍稀释因子的计算方法。
样本正常测试时，将体积 的样本与体积 的稀释液混合后，再吸取体积 的稀释样本，与总体积 的试剂反应。
定标稀释时，将体积 的样本与体积 的稀释液混合后，再吸取体积 的稀释样本，与总体积 的试剂反应。
正常测试时的样本预稀释比为 ：
 
注意：如果正常测试未进行样本稀释，则取D=1；
定标测试时的样本预稀释比为 ：
 
注意：如果定标测试未进行样本稀释，则取D’=1；

定标稀释的稀释因子K计算如下：
 

4.5	定标类型及参数计算
在BS系列生化仪中，定标方法分为两大类，即线性定标和非线性定标，其中线性定标又包括单点线性定标（K因数法）、两点线性定标和多点(大于2点)线性定标，主要适用于比色法测定的项目；非线性定标主要包括Logistic-Log 4P、Logistic-Log 5P、Exponential5P、Polynomial5P、Parabola和 Spline，主要适用于比浊法测定的项目。
几点说明：
1．	R表示标准品最终的反应度
2．	C 表示标准品的浓度(对非线性定标，对应为内部转换浓度)
3．	K、R0、a、b、c、d表示定标参数
4.5.1	线性定标
4.5.1.1	单点线性(K因数法)
该种定标方式要求用户输入K因数， 
定标公式： 。
其中K为用户输入的K因数，R0为试剂空白(第一标准品）反应度,若没有运行试剂空白,则R0=0.
注意：此时的R,R0要除以10000。
4.5.1.2	两点线性
定标公式： 。
有2个定标参数，K和R0，其中 ， 。
要求提供2个标准品，C1、C2为标准品1和2的浓度，R1、R2为标准品1和2的反应度。
4.5.1.3	多点线性
定标公式： 
有2个定标参数，K和R0。要求提供n(n≥3)个标准品，设Ci为标准品i的浓度，Ri为标准品i的反应度。利用线性最小二乘法求解K和R0得：
 ；     ；
4.5.2	非线性定标
4.5.2节中所有出现的浓度，如无特别说明，均指内部转换浓度。其中，最低浓度校准品的内部转换浓度为0。
4.5.2.1	Logistic-Log4P
定标公式： 
此定标方式共有4个参数，即R0、K、a和b。要求提供至少4个标准品。利用L-M法求解参数R0，K、a和b。(具体见Levenberg–Marquardt法（简称L-M法）)。
适用于随着浓度增加，其反应度增加越来越小的定标曲线，如下图。

 
图20 Logistic－Log 4P定标曲线
4.5.2.2	Logistic-Log5P
定标公式： 
此定标方式共有5个参数，即R0、K、a、b和c。 要求提供至少5个标准品，利用L-M法求解参数R0，K、a 、b和c。
适用范围同Logistic-Log 4P，只是曲线拟合程度更高。
4.5.2.3	Exponential5P
定标公式： 
此定标方式共有5个参数，即R0、K、a、b和c。要求提供至少5个标准品，利用L-M法求解参数R0，K、a 、和c。
适用于浓度增加到一定程度后，其反应度增加越来越大的定标曲线，如下图。
 
         图21 Exponential5P定标曲线
4.5.2.4	Polynomial5P
定标公式：   
此定标方式共有5个参数，即R0、a、b、c和d。要求提供至少5个标准品，第1个标准品（内部转换浓度为零）对应的R就等于R0，因此R0可作为已知参数。
令 ， 
则 为标准的3次多项式，可以利用多项式最小二乘法求解。
4.5.2.5	Parabola
定标公式： 
此定标方式共有3个参数，即a、b和R0。 要求提供至少3个标准品。利用多项式最小二乘法求解。
4.5.2.6	Spline
定标公式： 
此定标方式要求提供2-9个标准品，设标准品个数为 ，则此定标方式共有4（ －1）个参数，即 、 、 和 。由于是分段拟合，其拟和程度在所有定标类型中最高。
利用4.5.2节介绍的Spline插值函数参数求解方法求解 、 、 和 。
4.5.3	定标曲线
将用户输入的标准品浓度的下限值上限值之间分成若干（如50）等份。利用每个等分点上，由定标曲线公式求得的拟和反应度标点做图。对于非线性定标来说，下限值上限值之间分的等份越多，曲线越平滑。
4.6	定标曲线单调性判断
仅对非线性定标有效。本节中所有出现的浓度C，如无特别说明，均指内部转换浓度。
判断定标曲线的单调性，首先要判断定标数据（Ci，Ri）是否单调，如：按标准品浓度水平进行排序（升序），C1<C2.<….<Cn，判断标准品对应的反应度是否是单调（升序或降序排列），如果不是，则给出“MON” 标记并报警。此种情况下不再进行定标参数的计算，定标失败。若定标数据是单调的，需要进一步的判断拟和出的定标曲线是否是单调的，具体如下。
4.6.1	Logistic-Log4P
定标公式： 
求导得： ，因此Logistic-Log4P定标曲线是单调的，无需根据定标参数做进一步的判断。
4.6.2	Logistic-Log5P
定标公式： 
求导得： 
求驻点，即令 ，由于 ，得 
因此，判断Logistic-Log5P是否单调，即判断驻点 是否在标准品浓度范围内，也就是判断 是否满足，若不满足，则单调，否则不单调，给出“MON” 标记并报警，定标失败。其中Cstd1为浓度最低的标准品的浓度（取0.01），Cstdn为浓度最高的标准品的浓度。
4.6.3	Exponential5P
定标公式： 
求导得： 
求驻点，即令 ，得二次方程 
若c=0，则 ， ，否则计算 ， ，若 <0，
无解。若 >0，则 ，得   ， 。
单调性判断流程图如下：
 
图22 Exponential5P定标曲线单调性判断流程图
其中Cstd1为浓度最低的标准品的浓度（取0.01），Cstdn为浓度最高的标准品的浓度。
4.6.4	Polynomial5P
定标公式：   
令 ， ，则 
求导： ，求驻点，即令 ，得二次方程 
若d=0，则 ，即 ，否则计算 ，若 <0，无解；
若  >0，则 ，得   ，
 。
Polynomia5P定标曲线单调性判断流程如下：
 
图23 Polynomia5P定标曲线单调性判断流程图
其中Rstd1为浓度最低的标准品的反应度，Rstdn为浓度最高的标准品的反应度。
4.6.5	Parabola
定标公式： 
求导： ，驻点 ，若满足 ，则不单调，否则单调。
4.6.6	Spline
定标公式： 
求导： 
求驻点，即令 ，得二次方程 
若ci=0，则 ，否则计算 ，若 <0，无解；
若 >0，则 ，即 ， 。
对于Spline定标曲线的每一区间，都要进行单调性判断。每一区间的单调性判断规则如下：
 

图24 Spine定标曲线单区间单调性判断流程图
其中Cstdi为第i区间的低浓度标准品的浓度，Cstdi+1为第i区间的高浓度标准品的浓度。必须保证每一区间都是单调的，Spline定标曲线才是单调的，否则给出“MON” 标记并报警，定标失败。
4.7	定标算法
在求解定标参数时，用到多项式最小二乘法、L-M法以及SPLINE法。下面将详细介绍。
注：针对非线性定标，本节中所有出现的浓度C，如无特别说明，均指内部转换浓度。

4.7.1	最小二乘法
实际中往往通过观测得到数据，一般地，所给数据是有误差的。此时，如果要求近似函数过全部已知点，相当于保留全部数据误差，这是不合理的。数据拟合的最小二乘问题是：根据给定的数据组（ ）( =1,2…,n)，选取近似函数形式，即给定函数类H，求函数 ，使得
 
为最小，即：
 
这种求近似函数的方法称为数据拟合的最小二乘法，函数 称为这组数据的最小二乘函数。
4.7.1.1	多项式最小二乘法
在非线性定标中，用到3次多项式，下面来推导3次多项式的最小二乘法。
设观测数据组为（ ）( =1,2…,n且 )，三次多项式回归函数为：
 
选取参数 
使得 为最小， 
由多元函数取极值的必要条件，得方程组
  =0 
经整理得正规方程组：
 
令           
则  ，  。
线性最小二乘法是一次多项式最小二乘法，则
     
求得
     
4.7.1.2	非线性最小二乘法
非线性定标中的Logistic-Log4P , Logistic-Log5P不是简单的多项式函数，也不能转化为多项式函数，必须利用非线性最小二乘法来解决。
令 ，  其中 ， 且 。
选取参数 使得  为最小，式中 没有什么实际意义，只是为了计算的方便而设。
 ，即 
其中 ， 为Jacbio矩阵。
由多元函数取极值的必要条件，求 的极小值，即令 。
4.7.1.2.1	Gauss-Newton法（简称G-N法）
Gauss-Newton法的基本思想是，利用 的泰勒展开式来近似代替 ，从而把求 的解转化成求其对应的泰勒展开式的解。
设 有二阶导数，则 的二阶泰勒展开式：
 
当h足够小时，
 
 
                 
                 
  ,  
可见， ， 与h无关，如果 是满秩的， 是对称正定的。因此， 有唯一的最小值。
求 的最小值，令 ，即 
令  ， ， 为 的逆矩阵， 则 
由于 ，因此  为 的下降方向，经典的Gauss－Newton法取 为下一步的迭代步长，即：  。
Gauss－Newton法对初值的要求比较高，且必须保证迭代过程中 是非奇异矩阵（满秩矩阵），但在实际应用中，这两点都不易满足，从而导致Gauss－Newton迭代失败。
4.7.1.2.2	Levenberg–Marquardt法（简称L-M法）
为了克服Gauss－Newton的缺陷，防止迭代过程中矩阵 的非奇异，令 ， 称为阻尼因子，这就是阻尼Gauss－Newton法，也称Levenberg–Marquardt法（简称L-M法）。
L-M法的迭代步长为： 。
阻尼因子 有如下几个作用：
1．	 >0时，系数矩阵 始终是正定的，保证了 的存在，从而保证了 的下降方向。
2．	如果 比较大，则 ，比较适合迭代值远离数值解的情况。
3．	如果 值非常小，则 ，比较适合迭代值接近数值解的情况。
可见，阻尼因子不仅影响着迭代方向，也影响着迭代步长，初值 的选取与矩阵 的元素值有关，可以令 ，L-M法对 值的选取不敏感，一般的，如果确定 初值接近数值解， 取 ，否则 取 或1。
 在迭代过程中的更新受增益比 的控制，  
 更新规则如下：若 >0， ， 
              否则， ， 
下图示出了 与增益比 的关系。
 
图25   与增益比 的关系曲线
对于增益比 的说明：
1．	增益比 的分母
 
  
由于 ， ， 故 。
2．	如果增益比 比较大，说明 很好地逼近 ，此时可以降低 值，使L-M法的下一迭代步长接近与Gauss－Newton法的迭代步长；相反，如果增益比 比较小或者负值，则 不能很好地逼近 ，此时必须增大阻尼因子 ，从而更快地找到最速下降方向，减小迭代步长。


迭代中止原则如下：
1．	为保证最小值，须满足 ，因此当 时，迭代中止。 为大于0的一极小值。
2．	迭代步长很小，则迭代中止，即满足 时，迭代中止， 为大于0的一极小值。
3．	为防止迭代进入死循环，满足 时，迭代中止。
当 选择的过小，以至于在迭代过程中， 的舍入误差对迭代产生很大影响时，则会导致 增益与 增益的不一致，增益比 减小，从而导致 急剧增大，迭代步长 急剧减小，此时可用上述的后两个迭代中止条件退出循环。
综上所述，L-M法算法如下：
（1）	给定初始值 ，精度 ， ， ， ， ，V=2
（2）	计算Jacobi矩阵 ， ， ，若 ，则初值为解，停止计算，否则 ，转向（3）。
（3）	解方程组 ，求出迭代步长 。
（4）	若 ，则得到解 ，停止计算，否则转向（5）。
（5）	 ，若 ，转向（6），否则转向（7）
（6）	 ， , ，若 ，则得到解 ，停止计算。否则 ， ，转向（3）。
（7）	 ， ，转向（3）。
（8）	若 ，则没有找到满足精度的解，定标失败。此时以最大迭代次数Kmax的迭代根为近似解即令 ，给出此次的拟和度值（决定系数值），并给出未收敛“COV”标记。

4.7.2	Spline插值函数
非线性定标类型中有三次样条函数Spline定标，三次样条插值函数  满足：
1.	 （ ）；
2.	在每个小区间  ( )上 是三次多项式；
3.	  在给定区间上二阶连续可微。
令  （k=1,2..n-1）
下面推导以节点处的导数值为参数的三次样条插值函数。
设 ， ， ，则三次样条插值公式及其一阶，二阶导数可表示一阶倒数的函数：
 
 
 
可见，   
 
 
  
三次样条函数必须满足二次导数连续，即 
整理得：  

n个未知数，n－2个方程，必须寻找边界条件，即在区间的两个端点处给出条件，才能完全确定 ，结合实际问题，可考虑如下边界条件：
假设x(1)和x（n）处的一阶倒数是已知的：
 
 
这样，可以得到一个线性代数方程组： 
 
        
然后我们可以计算出各个节点的一阶导数 
     d为n阶列向量。
一阶导数求出后，可计算出二阶导数及三阶导数：
 
        k=1,2….n-1
综上，可求出三次样条函数 ，（k=1,2..n-1）。
4.7.3	非线性定标类型利用L-M法求解时的f函数及J函数
4.7.3.1	Logistic-Log4P
定标公式： 
利用L-M法求解参数RO，K、a和b。
L-M法求解中用到的f函数及J矩阵如下：
令 ， , 为方程个数。
则  ， ， 。
令R0的迭代初始值为R1（0浓度标准品的反应度），则x迭代初始值 。 为浓度最大标准品的反应度。
   则 对应的Jacbio矩阵为： 
 
注意：由于定标公式中有LnC函数，因此对于C为0时，取C=10－3。
4.7.3.2	Logistic-Log5P
定标公式： 
利用L-M法求解参数K、a b和c。L-M法求解中用到的f函数及J矩阵如下：
令 ，则 ， ， 。 , 方程个数。
令R0的迭代初始值为R1（0浓度标准品的反应度），则x迭代初始值 。 为浓度最大标准品的反应度。
则 对应的Jacbio矩阵为： 
 
注意：由于定标公式中有LnC函数，因此对于C为0时，取C=10－3。
4.7.3.3	Exponential5P
定标公式： 
利用L-M法求解参数中用到的f函数及J矩阵如下：
令 ， ，  ， 。 , 方程个数。
令R0的迭代初始值为R1（0浓度标准品的反应度），则x迭代初始值 。 为浓度最大标准品的反应度。
则 对应的Jacbio矩阵为： 
 
注意：由于定标公式中有LnC函数，因此对于C为0时，取C=10－3。






第5章 测试结果的计算
浓度的计算根椐选用的不同定标类型而计算公式不同，下面将一一列举。
对于某些非线性定标类型，要用到二分法求解浓度，因此下面首先介绍二分法算法。
5.1	非线性方程f(x)＝0的二分法求解
设 在区间[ ]上连续，且 ，则由连续函数介值定理， 在（ ）必有零点。二分法求解算法如下：
（1）	输入 ， ，误差限 ，最大容许迭代次数N
（2）	置n＝0
（3）	 
（4）	若 或 ，输出 ，停止计算，转（5）
（5）	若 ，转（6），否则输出失败信息，停止计算。
（6）	若 ，则 ；否则， 
（7）	置 ，转（3）
5.2	浓度计算
样本浓度结果的计算过程如下图所示。
 
图26 样本浓度计算过程
5.2.1	线性定标
1.	单点线性（K因数法）
 ，K为用户输入的计算因数，R0为定标参数。 
注意：此时的R,R0要除以10000。
2.	两点线性定标
  ，K和R0为定标参数。
3.	多点线性定标
 ，K和R0为定标参数。
若以上得出的测试结果C为负值，给出负值结果即可（为方便灵敏度试验）。

5.2.2	非线性定标
已知样本反应度，由定标类型和定标参数，按照本小节介绍的方法，先计算出对应的内部转换浓度。计算出内部转换浓度后，加上用户输入的最低浓度定标液值C[1]，即得到浓度结果。本节中所有出现的浓度C，如无特别说明，均指内部转换浓度。
	样本反应度是否超出标准品反应度范围检查
设Rx为样本反应度，Rcmin为最小浓度标准品反应度，Rcmax为最大浓度标准品反应度。则样本反应度范围的判断方法：
1.	样本反应度是否在标准品反应度范围内
判断方法：   or  
2.	样本反应度超过最大浓度标准品反应度
判断方法：  or   
3.	样本反应度低于最小浓度校准品反应度
非线性判断方法：  or  
线性定标判断方法：  or  

判断样本反应度的范围后的处理方式：
1.	如果样本反应度低于最小浓度校准品反应度，内部转换浓度C=0；同时给出“LOW”标记，不报警。
2.	如果样本反应度超过最大浓度标准品反应度检查，对于spline定标，给出参考结果，同时给出“RRN”标记并报警；对于其他的非线性定标，不再进行测试结果的计算，给出“RRN”标记并报警。
	内部转换浓度的计算方法
1.	Logistic-Log 4P
 ，R0、K、a和b为定标参数。
2.	Logistic-Log 5P
用二分法求正实根。
3.	Exponential5P
二分法求正实根。
4.	Polynomial5P
 
R0、a、b、c和d为定标参数。
5.	Parabola
对一元二次方程aC2+bC+R0-R=0 求定标液浓度范围内的正实根。 
6.	Spline
Spline根据标准品浓度所对应的反应度划分计算区间，每个区间其具体的计算参数不同，因此，进行SPLINE计算前，要先确定目前测定的反应度在哪个区间上，决定用哪组计算参数进行计算，取相应区间的计算参数参与计算，用二分法求正实根。
对于不在Spline计算区间的反应度，采用如下处理：
1）	当样本反应度低于最小浓度校准品反应度，内部转换浓度C=0；同时给出“LOW”标记，不报警。
2）	当样本反应度超过最大浓度标准品反应度时，C=(Cn-Cn-1)/(Rn-Rn-1)×(R-Rn)+Cn；Rn，Cn为最大浓度标准品的反应度及内部转换浓度，Rn-1，Cn-1为次最大浓度标准品的反应度及内部转换浓度。此种情况下，给出参考的计算结果，并给出“RRN”标记并报警。
	浓度结果的计算
计算出内部转换浓度后，加上用户输入的最低浓度定标液值C[1]，即得到浓度结果。
5.2.3	样本增量或减量测试结果的计算
样本增量与减量后，测试结果必须做相应的修正，计算如下：
C= 
其中C为样本增量与减量修正后的测试结果，Cd为修正前的测试结果（根据定标直接算出的结果），VS为正常的实际样本量（定标时的实际样本量），VS’为增量或减量后的实际样本量， 表示所有参与反应的试剂量。
5.2.4	自动稀释测试结果的计算
自动稀释时，用户需输入样本量及本次测试的稀释倍数D，最终测试结果计算如下：
 
其中， 为正常测试的稀释倍数，如果正常测试未稀释样本，则该值为1；
Cd为样本增量与减量修正后的测试结果。
5.2.5	测试结果相关性修正
修正系数(斜率和截距）可用于完成相关性修正，使本仪器获得的结果同其他仪器获得的结果相匹配。对有些测试，本仪器给出的结果可能始终比预期值或其他仪器获得的值高或低。为了使结果与预期结果或与其他仪器获得的结果相匹配，可对测试结果进行相关性修正。
修正系数包括两种：
	Service setup里各项目的光度计校正系数slope（斜率）和offset（截距）
修正后的计算结果为： 。默认值为：slope＝1，offset＝0.
	项目参数里用户设置的校正系数k（斜率）和b（截距）
修正后的计算结果为： 。默认值为：k＝1，b＝0.	
先进行Service setup修正，再进行项目参数中用户设置的相关性修正。
Service setup里修正系数如果不为默认值，不对结果进行标记。
项目参数里修正系数如果不为默认值，对结果进行“CAL”标记，不报警。
5.2.6	手工稀释测试结果的计算
如果用户设置了样本的手工稀释倍数，最终测试结果计算如下：
 
其中，Cd为样本相关性修正后的测试结果。
5.3	浓度水平检查
1. 	线性范围检查
	线性范围的自动调整：
 
项目参数中设置的线性范围上下限，分别乘以因子K，得到比例调整后的线性范围。
	线性范围判断：
计算出的样本浓度和比例调整后的线性范围比较，若超出上限，给出“>”标记；若低于下限，给出“<”标记。不报警。
2. 	危机值范围检查
若样本浓度不在危机值范围内，如超出上限，在结果上给出“↑!”标记，超出下限，给出“↑!”标记。不报警。
3. 	正常参考范围检查
若样本浓度不在正常参考范围内，如超出上限，在结果上给出“↑”标记，超出下限，给出“↓”标记。不报警。
4. 	质控
若质控液的测试结果违犯了相应的质控规则，在失控报警栏给出相应的标记。质控相关说明，参见“KF-BA80-3-548(1.0)操作软件需求说明书-质控”。

第6章 自动重测
自动重测条件：
1. 	超过正常参考值范围上限：默认为空，可选正常、稀释、减量重测、空（不重测）；
2. 	低于正常参考值范围下限：	默认为空，可选正常、增量重测、空；
3. 	超过危机值范围上限：默认为空，可选正常、稀释、减量重测、空； 
4. 	低于危机值范围下限：	默认为空，可选正常、增量重测、空； 
5. 	超过试剂盒规定的线性范围上限：默认为空，可选正常、稀释、减量重测、空；
6. 	低于试剂盒规定的线性范围下限：默认为空，可选正常、增量重测、空；
7. 	样本反应度超过最大浓度标准品反应度（非线性定标）：默认稀释重测，可选正常、稀释、减量重测、空； 
8. 	样本反应度低于最低浓度标准品反应度（非线性定标）：默认为空，可选正常、增量重测、空；
9. 	出现底物耗尽(固定时间法)：默认稀释重测，可选正常、稀释、减量重测、空；
10. 	非线性(动力学法)：默认为空，可选正常、稀释、减量重测、空； 
11. 	无线性区间(动力学法)：默认为空，可选正常、稀释、减量重测、空；
12. 	无计算区间(动力学法)：默认稀释重测，可选正常、稀释、减量重测、空； 
13. 	前带检查异常：默认稀释重测，可选正常、稀释、减量重测、空； 

系统设置中针对各种重测条件给出默认的自动重测设置。
如果用户没有相应的设置增量、减量或稀释测试的参数，则不对该样本进行相应重测。
	















自动重测优先级（判断流程）如下图，从上向下优先级逐渐降低。
                                     
  图27 自动重测优先级

第7章 各类检查与报警总结
7.1	吸光度/反应度检查
1. 	反应度计算错误
计算反应度时，出现计算用到的吸光度数据不完整或除0的错误，给出” RCE”标记并报警.
2. 	吸光度范围检查
检查反应曲线中，参与结果计算及判断的测光点的主副波长吸光度是否在参数界面的吸光度限内,若不在吸光度限内,给出” ABS”标记并报警.
参与吸光度范围检查的测光点包括：
空白时间段测光点，启动点至反应时间段终点的测光点；前带检查中，抗原再添加的q1和q2点；或反应速度比检查的q1至q2、q3至q4段的测光点。
对主副波长意外的其他波长，或主副波长中不参与结果计算及判断的测光点，不进行吸光度范围检查。
2．R1空白吸光度检查
正常测试时（包含定标、质控测试），记录加入样本前一周期（P4测光点）的吸光度，并与项目参数中的R1空白吸度范围比较，超出此限，给出“RBK”标记并报警；输入范围为-32000～32000，允许输入空，为空时表示不进行检查。
3. 	底物耗尽检查（固定时间法）
若固定时间法判断为底物耗尽，给出底物耗尽“BOE”标记并报警。
4. 	读数窗内和底物耗尽限内的测光点个数N检查（动力学法）
若N=2，给出无线性区间“NLN”标记，不报警。N>2时，无标记。N<2则启动酶线性扩展。
5. 	酶线性扩展（动力学法）
对于利用酶线性扩展计算出的测试结果，给出“EXP”标记，不报警。
若延迟时间内且在底物耗尽限内的测光点个数少于2个，给出无计算区间“ENC”标记，并报警。
6. 	线性判断（动力学法）
若线性范围的反应数据不满足线性判断，给出非线性“LIN”标记，并报警。
7. 	前带检查
免疫比浊法项目前带检查异常，给出前带检查异常“PRO”标记，并报警。
7.2	浓度检查
1. 	线性范围检查
计算出的样本浓度和比例调整后的线性范围比较，若超出上限，给出“>”标记；若超出下限，给出“<”标记。不报警。
2. 	危机值范围检查
若样本浓度不在危机值范围内，超出上限，给出“↑!”标记，超出下限，给出“↓!”标记。不报警。
3. 	正常参考范围检查
若样本浓度不在正常参考范围内，如超出上限，在结果上给出“↑”标记，超出下限，给出“↓”标记。不报警。
4. 	质控
若质控液的测试结果违犯了相应的质控规则，在失控报警栏给出相应的标记。
质控相关说明，参见“KF-BA80-3-548(1.0)操作软件需求说明书-质控”。
5. 	样本反应度超过最大浓度标准品反应度检查（非线性定标）
若样本反应度超过最大浓度标准品反应度检查，对于spline定标，给出参考结果，同时给出“RRN”标记并报警，对于其他的非线性定标，不再进行测试结果的计算，给出“RRN”标记，并报警。
6. 	样本反应度低于最小浓度标准品反应度检查（非线性定标）
若样本反应度低于最小浓度校准品反应度，给出参考结果，同时给出“LOW”标记，不报警。
7. 	校正后结果的标记
Service setup里修正系数如果不为默认值，不对结果进行标记。
项目参数里修正系数如果不为默认值，对结果进行“CAL”标记，不报警。
7.3	定标检查
1. 	混合空白吸光度检查
只有0浓度定标测试时检查混合试剂空白。记录反应时间终点时刻的吸光度，并与混合试剂空白吸光度范围比较，超出此限，给出“MBK”标记并报警。
2. 	空白反应度检查
只有0浓度定标测试时检查空白反应度。超出限制，给出“BLK” 标记并报警。
3. 	定标重复性检查
定标重复性：指每个标准品有效测定次数反应度的最大与最小值之差。该差值有一允许范围，可作为参数“重复测定差别限”输入仪器，大于此限给出“DUP” 标记并报警。
4. 	定标灵敏度检查
定标灵敏度：指最大浓度标准品和最小浓度标准品最终反应度的差值。
这个差值同样有一定的经验范围，也可作为参数“定标灵敏度限”输入仪器，用作灵敏度检查，小于此值给出“SEN” 标记并报警。
5. 	定标曲线标准差检查
多点线性和非线性定标，计算出的定标曲线标准差与用户输入的“定标曲线标准差”比较，大于此限，给出“CSD” 标记并报警，并给出此次定标的定标曲线拟和度。
6. 	定标曲线拟合度检查
多点线性和非线性定标，计算出的定标曲线拟合度与用户输入的“定标曲线拟合度”比较，低于此限，给出“DET” 标记并报警。
7. 	定标系数差别限检查
定标系数差别：仅对线性定标有效，指定标参数k(曲线斜率)本次与上次的差别((本次-上次)/上次)。超过用户输入的“定标系数差别限”，给出“FAC” 标记并报警。
8. 	非线性定标曲线单调性检查
非线性定标曲线不是单调的，即反应度与浓度不是一一对应的关系，若定标曲线不是单调的，给出“MON” 标记并报警，定标失败。
9. 	非线性定标曲线收敛性检查
在非线性定标迭代求解时，若迭代到一定次数（如1000次），仍没有找到满足精度的解，定标失败。此时以最大迭代次数Kmax的迭代根为近似解，但需给出此次定标的拟和度值（决定系数值），并给出未收敛“COV” 标记并报警。


附录A 相对BS400算法的更改点
BS800算法相对BS400算法的一些更改点，具体参见：
 
附录B 图、表目录
图1溶液对光的吸收	6
图2 双波长测量	7
图3 BS-800双试剂项目测试流程	8
图4 BS-800四试剂项目测试流程	8
图5 BS-800双试剂项目光测图	9
图6 BS-800四试剂项目光测图	10
图7 抗原抗体反应的剂量反应曲线	12
图8 抗原再添加的反应曲线	13
图9 抗原再添加的测试流程	13
图10 抗体过剩的时间反应曲线	14
图11 抗原过剩的时间反应曲线	14
图 12  血清干扰物吸收光谱	15
图13  数据处理流程图	17
图14  动力学法数据处理流程	22
图15 动力学法线性范围判断流程	23
图16 动力学法线性范围	23
图17  线性度计算	25
图18 酶线性范围扩展	26
图19  定标处理流程图	31
图20 Logistic－Log 4P定标曲线	35
图21 Exponential5P定标曲线	36
图22 Exponential5P定标曲线单调性判断流程图	38
图23 Polynomia5P定标曲线单调性判断流程图	39
图24 Spine定标曲线单区间单调性判断流程图	41
图25   与增益比 的关系曲线	45
图26 样本浓度计算过程	51
图27 自动重测优先级	57

表 1  BS800无效点和启动点说明	11
表2 血清指数算法参数	16
表 3  终点法反应度计算总结	20
表 4  固定时间法反应度计算总结	21
表 5  动力学法反应度计算总结	24
表 6  BS800默认启始时间段	27
表7 反应曲线特征量	28
表8 定标设置中的参数解释	29


